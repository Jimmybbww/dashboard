---
title: "心血管健康分析儀表板"
format: 
  dashboard:
    theme: flatly
    orientation: columns
author: "Claude Data Analyst"
date: last-modified
execute:
  echo: false
  warning: false
  message: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(DT)
library(corrplot)
library(data.table)
library(bslib)

theme_set(theme_minimal(base_family = "PingFang TC"))

set.seed(123)
survey_data <- fread("../data/release_list_survey.csv", encoding = "UTF-8", nrows = 1000)
measure_data <- fread("../data/release_list_measure.csv", encoding = "UTF-8", nrows = 1000)

demo_data <- survey_data %>%
  select(Release_No, AGE, SEX) %>%
  filter(!is.na(AGE), !is.na(SEX)) %>%
  mutate(AGE = as.numeric(AGE), SEX = as.numeric(SEX))

cardio_data <- measure_data %>%
  select(Release_No, T_CHO, HDL_C, LDL_C, TG, SIT_1_SYSTOLIC_PRESSURE, SIT_1_DIASTOLIC_PRESSURE) %>%
  mutate(
    T_CHO = as.numeric(T_CHO),
    HDL_C = as.numeric(HDL_C),
    LDL_C = as.numeric(LDL_C),
    TG = as.numeric(TG),
    SBP = as.numeric(SIT_1_SYSTOLIC_PRESSURE),
    DBP = as.numeric(SIT_1_DIASTOLIC_PRESSURE)
  ) %>%
  select(Release_No, T_CHO, HDL_C, LDL_C, TG, SBP, DBP)

full_data <- demo_data %>%
  inner_join(cardio_data, by = "Release_No") %>%
  mutate(
    性別 = ifelse(SEX == 1, "男性", "女性"),
    年齡組 = case_when(
      AGE < 40 ~ "40歲以下",
      AGE < 60 ~ "40-59歲", 
      TRUE ~ "60歲以上"
    )
  ) %>%
  filter(!is.na(T_CHO) | !is.na(HDL_C) | !is.na(LDL_C) | !is.na(TG))

total_participants <- nrow(full_data)
male_count <- sum(full_data$性別 == "男性", na.rm = TRUE)
female_count <- sum(full_data$性別 == "女性", na.rm = TRUE)
avg_age <- round(mean(full_data$AGE, na.rm = TRUE), 1)
```

# 概覽

## Column {width=30%}

### 基本統計

**總參與者數**: `r scales::comma(total_participants)`

**男性參與者**: `r scales::comma(male_count)`

**女性參與者**: `r scales::comma(female_count)`

**平均年齡**: `r avg_age`歲

## Column {width=70%}

### 年齡與性別分布
```{r}
p1 <- full_data %>%
  ggplot(aes(x = AGE, fill = 性別)) +
  geom_histogram(bins = 20, alpha = 0.7, position = "identity") +
  scale_fill_manual(values = c("男性" = "#3498db", "女性" = "#e74c3c")) +
  labs(title = "年齡分布（依性別）", x = "年齡", y = "人數", fill = "性別") +
  theme_minimal()

ggplotly(p1)
```

# 人口統計

## Column {width=50%}

### 性別分布
```{r}
gender_summary <- full_data %>%
  count(性別)

p2 <- gender_summary %>%
  ggplot(aes(x = 性別, y = n, fill = 性別)) +
  geom_col() +
  scale_fill_manual(values = c("男性" = "#3498db", "女性" = "#e74c3c")) +
  labs(title = "參與者性別分布", x = "性別", y = "人數") +
  theme_minimal()

ggplotly(p2)
```

## Column {width=50%}

### 年齡組分布
```{r}
age_summary <- full_data %>%
  count(年齡組, 性別)

p3 <- age_summary %>%
  ggplot(aes(x = 年齡組, y = n, fill = 性別)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("男性" = "#3498db", "女性" = "#e74c3c")) +
  labs(title = "年齡組分布（依性別）", x = "年齡組", y = "人數", fill = "性別") +
  theme_minimal()

ggplotly(p3)
```

# 心血管指標

## Column {width=60%}

### 血脂指標分布
```{r}
lipid_data <- full_data %>%
  select(Release_No, 性別, T_CHO, HDL_C, LDL_C, TG) %>%
  pivot_longer(cols = c(T_CHO, HDL_C, LDL_C, TG), 
               names_to = "指標", values_to = "數值") %>%
  filter(!is.na(數值)) %>%
  mutate(
    指標 = case_when(
      指標 == "T_CHO" ~ "總膽固醇",
      指標 == "HDL_C" ~ "高密度脂蛋白",
      指標 == "LDL_C" ~ "低密度脂蛋白", 
      指標 == "TG" ~ "三酸甘油酯"
    )
  )

p4 <- lipid_data %>%
  ggplot(aes(x = 指標, y = 數值, fill = 性別)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("男性" = "#3498db", "女性" = "#e74c3c")) +
  labs(title = "血脂指標分布", x = "血脂指標", y = "數值 (mg/dL)", fill = "性別") +
  theme_minimal()

ggplotly(p4)
```

## Column {width=40%}

### 血壓分布
```{r}
bp_data <- full_data %>%
  select(Release_No, 性別, SBP, DBP) %>%
  filter(!is.na(SBP) & !is.na(DBP))

if(nrow(bp_data) > 0) {
  p5 <- bp_data %>%
    ggplot(aes(x = SBP, y = DBP, color = 性別)) +
    geom_point(alpha = 0.6) +
    scale_color_manual(values = c("男性" = "#3498db", "女性" = "#e74c3c")) +
    labs(title = "血壓分布散點圖", x = "收縮壓 (mmHg)", y = "舒張壓 (mmHg)", color = "性別") +
    theme_minimal()
  
  ggplotly(p5)
} else {
  print("血壓資料不足")
}
```

# 相關性分析

## Column

### 心血管指標相關性熱圖
```{r}
cor_data <- full_data %>%
  select(T_CHO, HDL_C, LDL_C, TG, SBP, DBP) %>%
  na.omit()

if(nrow(cor_data) > 10) {
  cor_matrix <- cor(cor_data)
  
  colnames(cor_matrix) <- c("總膽固醇", "高密度脂蛋白", "低密度脂蛋白", "三酸甘油酯", "收縮壓", "舒張壓")
  rownames(cor_matrix) <- colnames(cor_matrix)
  
  corrplot(cor_matrix, 
           method = "color",
           type = "upper",
           tl.cex = 0.8,
           tl.col = "black",
           tl.srt = 45,
           addCoef.col = "black",
           number.cex = 0.7)
} else {
  print("資料不足以進行相關性分析")
}
```

---

**資料來源**: 台灣生物資料庫  
**分析時間**: `r Sys.Date()`  
**樣本數**: `r total_participants` 位參與者